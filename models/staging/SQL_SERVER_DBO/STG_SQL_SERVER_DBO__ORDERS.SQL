
{{
  config(
    materialized = 'incremental',
    unique_key = 'ORDER_ID'
  )
}}

WITH SRC_ORDERS AS (
    SELECT * 
    FROM {{ source('SQL_SERVER_DBO', 'ORDERS') }}

{% if is_incremental() %}

	  WHERE _FIVETRAN_SYNCED > (SELECT MAX(DATETIME_ROW_LOADED) FROM {{ this }} )

{% endif %}

    ),

RENAMED_ORDERS AS (
    SELECT
        ORDER_ID,
        USER_ID,
        ADDRESS_ID AS SHIPPING_ADDRESS_ID,
        --CASE WHEN SHIPPING_SERVICE != '' THEN MD5(LOWER(SHIPPING_SERVICE)) ELSE '' END AS SHIPPING_SERVICE_ID,
        --{{ dbt_utils.generate_surrogate_key(["CASE WHEN SHIPPING_SERVICE != '' THEN SHIPPING_SERVICE ELSE '' END"]) }} AS SHIPPING_SERVICE_ID,
        {{ dbt_utils.generate_surrogate_key(["SHIPPING_SERVICE"]) }} AS SHIPPING_SERVICE_ID,
        SHIPPING_COST AS SHIPPING_PRICE_USD,
        ORDER_COST AS ORDER_PRICE_USD,
        -- MD5(CASE WHEN PROMO_ID = '' THEN 'no promo' ELSE PROMO_ID END) AS PROMO_ID,--YA
        {{ dbt_utils.generate_surrogate_key(["CASE WHEN PROMO_ID = '' THEN 'no promo' ELSE PROMO_ID END"]) }} AS PROMO_ID,
        ORDER_TOTAL AS ORDER_TOTAL_PRICE_USD,
        CONVERT_TIMEZONE('UTC', CREATED_AT) AS DATETIME_ORDER_CREATED,
        CONVERT_TIMEZONE('UTC', ESTIMATED_DELIVERY_AT) AS DATETIME_ESTIMATED_DELIVERY,
        CONVERT_TIMEZONE('UTC', DELIVERED_AT) AS DATETIME_DELIVERED,
        DATEDIFF(DAY, CONVERT_TIMEZONE('UTC', CREATED_AT), CONVERT_TIMEZONE('UTC', DELIVERED_AT)) AS DAYS_TO_DELIVER,
        TRACKING_ID AS SHIPPING_SERVICE_TRACKING_ID,
        STATUS AS STATUS_ORDER,
        _FIVETRAN_DELETED AS IS_ROW_DELETED,
        CONVERT_TIMEZONE('UTC', _FIVETRAN_SYNCED) AS DATETIME_ROW_LOADED
    FROM SRC_ORDERS
    )

SELECT * FROM RENAMED_ORDERS