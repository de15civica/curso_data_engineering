
{{
  config(
    MATERIALIZED = 'VIEW'
  )
}}

WITH SRC_EVENTS AS (
    SELECT * 
    FROM {{ source('SQL_SERVER_DBO', 'EVENTS') }}
    ),

RENAMED_EVENTS AS (
    SELECT
        EVENT_ID,
        PAGE_URL,
        --MD5(LOWER(EVENT_TYPE)) AS EVENT_TYPE_ID,
        {{ dbt_utils.generate_surrogate_key(['EVENT_TYPE']) }} AS EVENT_TYPE_ID,
        USER_ID,
        PRODUCT_ID, -- CHECK ESTA BIEN, SE UTILIZA PARA VER QUE PRODUCTOS SE ESTA REVISANDO EN EL EVENTO
        SESSION_ID, -- SE PODRIA NORMALIZAR SI TUVIESEMOS DATA DE DISPOSITIVO
        CONVERT_TIMEZONE('UTC', CREATED_AT) AS DATETIME_EVENT_CREATED,
        ORDER_ID,
        _FIVETRAN_DELETED AS IS_ROW_DELETED,
        CONVERT_TIMEZONE('UTC', _FIVETRAN_SYNCED) AS DATETIME_ROW_LOADED
    FROM SRC_EVENTS
    )

SELECT * FROM RENAMED_EVENTS