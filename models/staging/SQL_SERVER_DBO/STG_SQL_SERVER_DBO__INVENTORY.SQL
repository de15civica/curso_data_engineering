
{{
  config(
    MATERIALIZED = 'VIEW'
  )
}}

WITH SRC_PRODUCTS AS (
    SELECT * 
    FROM {{ source('SQL_SERVER_DBO', 'PRODUCTS') }}
    ),

MODIFY_PRODUCTS AS (
    SELECT
        PRODUCT_ID,
        INVENTORY,
        CAST(DATE(CONVERT_TIMEZONE('UTC', _FIVETRAN_SYNCED)) AS VARCHAR) AS TEXT_DATE,
        DATE(CONVERT_TIMEZONE('UTC', _FIVETRAN_SYNCED)) AS DATE,
        _FIVETRAN_DELETED AS IS_ROW_DELETED,
    FROM SRC_PRODUCTS
    ),

RENAMED_INVENTORY AS (
    SELECT
        MD5(CONCAT(PRODUCT_ID, TEXT_DATE)) AS INVENTORY_ID,
        PRODUCT_ID,
        INVENTORY,
        DATE
    FROM MODIFY_PRODUCTS
    )

SELECT * FROM RENAMED_INVENTORY
;